dist: xenial
language: python
python: 3.7
sudo: required
env:
  global:
    - BUILD=true
    - CI=true
    - CHARM_BUILD_DIR=/tmp/charm-builds
  matrix:
    - JUJU_CHANNEL=stable
    - JUJU_CHANNEL=edge
install:
  - sudo systemctl stop docker.service
  - sudo apt purge libyaml-dev
  - sudo apt install libffi6 libffi-dev
  - sudo snap install charm --classic
  - sudo snap install juju --classic --channel $JUJU_CHANNEL
  - sudo snap install juju-wait --classic
  - sudo snap install juju-helpers --classic --edge
  - sudo snap install microk8s --classic
  - sudo microk8s.status --wait-ready --timeout 60
  - pip install pytest pyyaml requests sh cffi black==19.3b0
script:
  - git config --global --unset protocol.version

  # Run regular deploy script
  - ./scripts/deploy-microk8s create --build --ci

  # Make Ambassador available and run tests
  - juju kubectl port-forward svc/ambassador 8081:80 &

  - pytest

  # Check everything, and make sure the extensionless scripts are included
  - black --check . ./scripts/*
after_failure:
  - microk8s.kubectl get pods --all-namespaces
  - juju status --format yaml
  - juju kubectl get pods \
      | grep CrashLoopBackOff \
      | cut -d' ' -f1 \
      | xargs -I[] bash -c "echo ==\> [] \<== && juju kubectl logs --tail 1000 --all-containers []"

