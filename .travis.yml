dist: xenial
language: python
python: 3.7
sudo: required
env:
  global:
    - BUILD=true
    - CHARM_BUILD_DIR=/tmp/charm-builds
  matrix:
    - JUJU_CHANNEL=stable
    - JUJU_CHANNEL=edge
matrix:
  allow_failures:
    - env: JUJU_CHANNEL=stable
install:
  - sudo apt purge libyaml-dev
  - sudo snap install charm --classic
  - sudo snap install juju --classic --channel $JUJU_CHANNEL
  - sudo snap install juju-wait --classic
  - sudo snap install microk8s --classic --channel 1.13/stable
  - pip install pytest pyyaml requests sh
before_script:
  - export PATH=$HOME/.cargo/bin:$PATH
  - echo $PATH
  - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  - git clone https://github.com/knkski/rust-libjuju.git
  - pushd rust-libjuju
  - cargo install --path plugins
  - popd
script:
  # Run regular deploy script
  - ./scripts/deploy-microk8s.sh

  # Make Ambassador available and run tests
  - microk8s.kubectl port-forward svc/ambassador -n kubeflow 8081:80 &
  - pytest
