dist: xenial
language: python
python: 3.7
sudo: required
env:
  global:
    - BUILD=true
    - CI=true
    - CHARM_BUILD_DIR=/tmp/charm-builds
  matrix:
    - JUJU_CHANNEL=stable
    - JUJU_CHANNEL=edge
matrix:
  allow_failures:
    - env: JUJU_CHANNEL=stable
install:
  - sudo systemctl stop docker.service
  - sudo apt purge libyaml-dev
  - sudo apt install libffi6 libffi-dev
  - sudo snap install charm --classic
  - sudo snap install juju --classic --channel $JUJU_CHANNEL
  - sudo snap install juju-wait --classic
  - sudo snap install juju-helpers --classic --edge
  - sudo snap alias juju-helpers.juju-bundle juju-bundle
  - sudo snap install microk8s --classic
  - sudo microk8s.status --wait-ready --timeout 60
  - pip install pytest pyyaml requests sh cffi
script:
  # Run regular deploy script
  - ./scripts/deploy-microk8s.sh

  # Make Ambassador available and run tests
  - microk8s.kubectl port-forward svc/ambassador -n kubeflow 8081:80 &
  - pytest
after_failure:
  - microk8s.kubectl get pods --all-namespaces
  - juju status --format yaml
after_success:
  - test $TRAVIS_BRANCH = "master" \
      && test $TRAVIS_PULL_REQUEST = "false" \
      && juju bundle publish --url cs:~kubeflow-charmers/kubeflow
